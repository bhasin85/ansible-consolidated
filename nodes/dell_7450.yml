- hosts: 131.217.38.36

  pre_tasks:
    - command: echo my pretask

  roles:
    - yaegashi.blockinfile
    - { role: distribution, template: debian.j2, version: testing, upgrade: safe, mirror: "http://mirror.aarnet.edu.au/debian" }

  sudo: no
  vars:
    - common: ./roles/common

  tasks:
    # hostname?


    # - role: zfs
    - include: ./roles/common/tasks/sudoers.yml
    - include: ./roles/common/tasks/disable-shell-bell.yml
    - include: ./roles/common/tasks/bridge.yml

    - user: name=meteo shell=/bin/bash groups=adm append=yes
    - include: ./roles/common/tasks/mydotfiles.yml user=meteo

    - include: ./roles/common/tasks/chefdk.yml
    - include: ./roles/common/tasks/grails-1.3.7.yml

    # TODO add devenv and desktop...
    - include: ./roles/common/tasks/devenv.yml
    - apt: name=maven
    - apt: name=postgresql-client-9.4

    # - include: "./roles/common/tasks/jdk.yml"
    - lineinfile: dest=/home/meteo/paths state=present insertafter=EOF line='export JAVA_HOME=/usr/java/jdk1.7.0_80'

    - apt: name=memtest86
    - apt: name=fail2ban

    - apt: name=alsa-oss
    - apt: name=alsa-utils
    - apt: name=alsa-tools

    - name: Setup soundcard
      blockinfile:
        dest: /etc/modprobe.d/alsa-base.conf
        create: true
        content: |
          # hdmi and cth reversed
          options snd_hda_intel enable=0,1

          # hardware beep off
          options snd_hda_intel beep_mode=0
          blacklist pcspkr
      notify: reboot

    - name: Initialize alsa
      # command: bash -c "/usr/sbin/alsactl"
      command: /usr/sbin/alsactl
      args:
        creates: /var/lib/alsa/asound.state
      notify: reboot

    - name: Wifi firmware
      apt: name=firmware-iwlwifi

    - name: Modprobe
      modprobe: name=iwlwifi state=present

    - name: Bring up interface
      command: /sbin/ifconfig wlp2s0 up

    - apt: name=wpasupplicant
    - apt: name=wicd-curses


    # make sure systemd is installed
    - apt: name=systemd-container
      when: (ansible_distribution == "Debian" and ansible_distribution_major_version > "8")

    - apt: name=debootstrap


  handlers:
    - include: ./roles/common/handlers/main.yml

