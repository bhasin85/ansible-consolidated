
# Based on https://wiki.debian.org/WordPress

- hosts:
    - wordpress
    - aodnblog
    - aodnblog2
  vars_files:
    - credentials.yml
  vars:
    - mirror: http://mirror.internode.on.net/pub/debian
    - version: jessie
    - upgrade: safe
    - timezone: Australia/Hobart
    - locale: en_AU.UTF-8
    - users:
      - { name: meteo,    group: adm, pubkey: "{{meteo_pubkey}}" }
  roles:
    - debian
    - timezone
    - locale
    - common
    - meteo-dotfiles
  tasks:
    - apt: name=mysql-server
    - apt: name=apache2
    - apt: name=wordpress

    - file: path="{{item}}" state=directory recurse=yes owner=www-data group=www-data
      with_items:
        - /var/lib/wordpress
        - /usr/share/wordpress

    - copy:
        dest: /etc/apache2/sites-available/wp.conf
        content: |
          Alias /wp/wp-content /var/lib/wordpress/wp-content
          Alias /wp /usr/share/wordpress
          <Directory /usr/share/wordpress>
              Options FollowSymLinks
              AllowOverride Limit Options FileInfo
              DirectoryIndex index.php
              Require all granted
          </Directory>
          <Directory /var/lib/wordpress/wp-content>
              Options FollowSymLinks
              Require all granted
          </Directory>

      notify: reload-apache2

    - command: a2ensite wp
      args:
        creates: /etc/apache2/sites-enabled/wp.conf

    # web site should now be up and accessible, http://host/wp/

    - copy:
        dest: /etc/wordpress/config-default.php
        # TODO deployed by ansible...
        # define('WP_ALLOW_REPAIR', true);
        content: |
          <?php
          ini_set('display_errors', 1);
          ini_set('display_startup_errors', 1);
          error_reporting(E_ALL);
          define('DB_NAME', 'wordpress');
          define('DB_USER', 'wordpress');
          define('DB_PASSWORD', 'wordpress');
          define('DB_HOST', 'localhost');
          define('WP_CONTENT_DIR', '/var/lib/wordpress/wp-content');
          ?>

    - copy:
        dest: /ansible/wp.sql
        content: |
          CREATE DATABASE if not exists wordpress;
          GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER
          ON wordpress.*
          TO wordpress@localhost
          IDENTIFIED BY 'wordpress';
          FLUSH PRIVILEGES;
      register: whoot

    # No default root password for myql on first install
    - shell: mysql -u root < /ansible/wp.sql
      when: whoot.changed == true

    # apche support large file upload
    # Note: that max_file_uploads = 20 didn't prevent bulk upload of more than 20 images...
    - lineinfile: >
        dest=/etc/php5/apache2/php.ini
        state=present
        backrefs=yes
        regexp='upload_max_filesize.*'
        line='upload_max_filesize = 32M'
      notify: reload-apache2

    - lineinfile: >
        dest=/etc/php5/apache2/php.ini
        state=present
        backrefs=yes
        regexp='post_max_size.*'
        line='post_max_size = 32M'
      notify: reload-apache2


    # Useful enough to be included here, TODO use system path
    - copy:
        dest: /home/meteo/backup.sh
        mode: 0755
        content: |
          #!/bin/bash -x
          # deployed by ansible!
          DIR=backup-$(date '+%DIR-%H-%M')
          mkdir $DIR
          cp -rp /var/lib/wordpress/ $DIR
          mysqldump --opt -u root wordpress > $DIR/wordpress.dump


  handlers:
    - name: reload-apache2
      command: service apache2 reload

