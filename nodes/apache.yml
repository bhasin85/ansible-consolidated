
  - hosts: apache
    roles:
      - yaegashi.blockinfile
    vars:
      - user: meteo
      - sshkey: "{{ lookup('file', '../resources/keys') }}"
      - mirror: "http://mirror.aarnet.edu.au/debian/"
    tasks:
      - include: ../roles/distribution/tasks/main.yml template=debian.j2 version=jessie upgrade=safe

      # - include: ../roles/common/tasks/basic.yml


      # apache
      - apt: name=apache2

      # mod proxy
      - apt: name=libapache2-mod-proxy-html

      # TODO this is not idempotent
      # enable proxy
      - command: a2enmod proxy proxy_http
      - command: a2enmod proxy proxy_html

      # TODO ordering,
      # disable default site
      - command: a2dissite 000-default.conf

      # aatams reverse proxy
      - blockinfile:
          dest: /etc/apache2/sites-available/default.conf
          create: true
          content: |
            <VirtualHost *:80>

              # DocumentRoot      /aatams
              # Require all granted
              ProxyPass         /aatams http://aatams:8080/aatams
              ProxyPassReverse  /aatams http://aatams:8080/aatams

              ProxyPass         /portal http://portal:8080/portal
              ProxyPassReverse  /portal http://portal:8080/portal

              ProxyPass         /geonetwork http://geonetwork2:8080/geonetwork
              ProxyPassReverse  /geonetwork http://geonetwork2:8080/geonetwork

              # Rewriting URLs in hyperlinks
              # ProxyHTMLEnable On
              # ProxyHTMLExtended On
              # ProxyHTMLURLMap http://apache/geonetwork2  /geonetwork


            </VirtualHost>
        notify: reload-apache2

      # aatams enable
      - command: a2ensite default


    handlers:
      - include: ../roles/common/handlers/main.yml


