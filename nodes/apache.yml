
  - hosts: apache
    roles:
      - yaegashi.blockinfile
    vars:
      - user: meteo
      - sshkey: "{{ lookup('file', '../resources/keys') }}"
      - mirror: "http://mirror.aarnet.edu.au/debian/"
    tasks:
      - include: ../roles/distribution/tasks/main.yml template=debian.j2 version=jessie upgrade=safe

      - include: ../roles/common/tasks/sudoers.yml

      - user: name=meteo shell=/bin/bash groups=adm append=yes
      - include: ../roles/common/tasks/mydotfiles.yml user=meteo
      - authorized_key: user=meteo key="{{sshkey}}"

      - include: ../roles/common/tasks/timezone.yml timezone=Australia/Hobart

      - apt: name=locales
      - locale_gen: name=en_AU.UTF-8 state=present


      - include: ../roles/common/tasks/devenv-lite.yml

      # apache
      - apt: name=apache2

      # mod proxy
      - apt: name=libapache2-mod-proxy-html

      # TODO this is not idempotent
      # enable proxy
      - command: a2enmod proxy proxy_http

      # TODO ordering,
      # disable default site
      - command: a2dissite 000-default.conf

      # aatams reverse proxy
      - blockinfile:
          dest: /etc/apache2/sites-available/aatams.conf
          create: true
          content: |
            <VirtualHost *:80>
              DocumentRoot      /aatams
              # Require all granted
              ProxyPass         /aatams http://aatams:8080/aatams
              ProxyPassReverse  /aatams http://aatams:8080/aatams

              ProxyPass         /geonetwork2 http://geonetwork2:8080/geonetwork
              ProxyPassReverse  /geonetwork2 http://geonetwork2:8080/geonetwork

            </VirtualHost>
        notify: reload-apache2

      # aatams enable
      - command: a2ensite aatams

      # SO IT works with one, but when we have two it doesn't work.
      # OK, because the DocumentRoot is actually refering to a directory...
      # and it's not discriminating at all...
      # so everything is going to the first <VirtualHost> that's created...

      # VERY IMPORTANT
      # Ahhh maybe we have just the one VirtualHost 
      # and then proxy for the different hosts inside that...

      # maybe the VirtualHost won't work?

      # not working for some reason?
      # geonetwork2 reverse proxy


    handlers:
      - include: ../roles/common/handlers/main.yml


