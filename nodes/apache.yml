
  - hosts: apache
    roles:
      - yaegashi.blockinfile
    vars:
      - user: meteo
      - sshkey: "{{ lookup('file', '../resources/keys') }}"
      - mirror: "http://mirror.aarnet.edu.au/debian/"
    tasks:
      - include: ../roles/distribution/tasks/main.yml template=debian.j2 version=jessie upgrade=safe

      - include: ../roles/common/tasks/sudoers.yml

      - user: name=meteo shell=/bin/bash groups=adm append=yes
      - include: ../roles/common/tasks/mydotfiles.yml user=meteo
      - authorized_key: user=meteo key="{{sshkey}}"

      - include: ../roles/common/tasks/timezone.yml timezone=Australia/Hobart

      - apt: name=locales
      - locale_gen: name=en_AU.UTF-8 state=present


      - include: ../roles/common/tasks/devenv-lite.yml

      # apache
      - apt: name=apache2

      # mod proxy
      - apt: name=libapache2-mod-proxy-html

      # enable proxy
      - command: a2enmod proxy proxy_http

      # disable default site
      - command: a2dissite 000-default.conf

      # aatams reverse proxy
      - blockinfile:
          dest: /etc/apache2/sites-available/aatams.conf
          create: true
          content: |
            <VirtualHost *:80>
              DocumentRoot      /aatams
              ProxyPass         /aatams http://aatams:8080/aatams
              ProxyPassReverse  /aatams http://aatams:8080/aatams
            </VirtualHost>
        notify: reload-apache2

      # aatams enable
      - command: a2ensite aatams

    handlers:
      - include: ../roles/common/handlers/main.yml


