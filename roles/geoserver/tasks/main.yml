
  - apt: name=tomcat7 update_cache=yes

  - apt: name=iptables-persistent
  - blockinfile:
      dest: /etc/iptables-rules
      create: true
      content: |
        # deployed by ansible!
        iptables -t nat --flush
        iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080
    notify: reconfigure-iptables

  - set_fact: tomcat7=/var/lib/tomcat7
  - set_fact: conf={{tomcat7}}/conf
  - set_fact: webapps={{tomcat7}}/webapps
  - set_fact: geoserver_config={{conf}}/geoserver-config
  - set_fact: lib={{tomcat7}}/lib

  # TODO change this to use with_items


  - file: path={{tomcat7}}    state=directory owner=tomcat7 group=tomcat7
  # - file: path={{conf}}     state=directory owner=tomcat7 group=tomcat7   already a link
  - file: path={{webapps}}    state=directory owner=tomcat7 group=tomcat7
  - file: path={{lib}}        state=directory owner=tomcat7 group=tomcat7

  # this is the ubuntu version of the db connection pool. using commons has bug
  # probbably class loader related, where throws with can't find Cursor on timer
  - copy:
      dest: "{{lib}}/tomcat-dbcp.jar"
      src: ../roles/geoserver/files/tomcat-dbcp.jar
      owner: tomcat7
      group: tomcat7

  - copy:
      dest: /etc/default/tomcat7
      backup: yes
      owner: tomcat7
      group: tomcat7
      content: |
        # deployed by ansible!
        TOMCAT7_USER=tomcat7
        TOMCAT7_GROUP=tomcat7
        JAVA_OPTS="${JAVA_OPTS} -DGEOSERVER_DATA_DIR={{geoserver_config}} \
          -Xmx4081m -Xms512m -server -XX:MaxPermSize=256m -XX:+HeapDumpOnOutOfMemoryError \
          -Xdebug -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n"
    notify: restart-tomcat7

    # factory="org.apache.commons.dbcp.BasicDataSourceFactory"        # debian
    # factory="org.apache.tomcat.dbcp.dbcp.BasicDataSourceFactory"    # ubuntu
  - copy:
      dest: "{{conf}}/context.xml"
      backup: yes
      owner: tomcat7
      group: tomcat7
      content: |
        <?xml version='1.0' encoding='utf-8'?>
        <!-- deployed by ansible! -->
        <Context>
            <!-- Default set of monitored resources -->
            <WatchedResource>WEB-INF/web.xml</WatchedResource>

            <Resource
                name="jdbc/harvest_read"
                auth="Container"
                type="javax.sql.DataSource"
                factory="org.apache.tomcat.dbcp.dbcp.BasicDataSourceFactory"
                driverClassName="org.postgresql.Driver"
                url="jdbc:postgresql://db-2-aws-syd.aodn.org.au:5432/harvest?loginTimeout=1000&amp;ssl=true&amp;sslfactory=org.postgresql.ssl.NonValidatingFactory"
                validationQuery="SELECT 1"
                username="" password=""
                maxActive="5" maxIdle="3" maxWait="-1"
                testOnBorrow="true" testWhileIdle="true" testOnReturn="true"
                timeBetweenEvictionRunsMillis="30000"
                numTestsPerEvictionRun="3"
                minEvictableIdleTimeMillis="60000"
                defaultAutoCommit="true"
            />
        </Context>
    notify: restart-tomcat7


  # allow geoserver to modify
  - git: >
      repo=https://github.com/aodn/geoserver-config
      dest={{geoserver_config}}
      version=master
      force=yes
    notify: restart-tomcat7

  - file: path={{geoserver_config}} state=directory owner=tomcat7 group=tomcat7 recurse=yes


  - copy:
      dest: "{{geoserver_config}}/security/usergroup/default/users.xml"
      backup: yes
      owner: tomcat7
      group: tomcat7
      content: |
        <?xml version="1.0" encoding="UTF-8"?>
        <userRegistry xmlns="http://www.geoserver.org/security/users" version="1.0">
          <users>
                <user enabled="true" name="admin" password="plain:admin"/>
          </users>
          <groups>
          </groups>
        </userRegistry>


  # war
  # TODO make war source configurable
  - get_url: >
      url=https://jenkins.aodn.org.au/job/geoserver_prod/lastSuccessfulBuild/artifact/au.org.emii/main/1.0.0/main-1.0.0.war
      dest={{webapps}}/geoserver.war
    notify: restart-tomcat7



